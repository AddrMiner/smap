## 主函数

```rust
fn main() {
    let mode;	// 定义模式
    {
        let args = Args::get_args();  // 获取命令行参数
        set_logger(&args);			// 配置 系统日志
        mode = Mode::new(&args);	  // 选择并创建模式
    }
    mode.execute(); // 执行模式
}
```

**SMap**的核心是**探测模式**（并非探测模块）的构造和执行。

不同探测模式之间代码逻辑与数据完全独立，但底层代码是高度复用的，这种设计能最大限度地让开发者快速设计和开发完全自定义的探测模式。

## 系统架构

![](./assets/1.svg)

**SMap**是一个大规模网络测量框架，不同算法实现的系统架构存在很大差异，但层次结构大体上是一致的。在系统运行时，首先由系统执行**关键信息初始化**，**命令参数解析**等必要步骤。然后根据初始化阶段解析到的参数进行**探测模式构造**。探测模式构造一般包括**基础配置**（网络接口获取，加密密钥初始化等），**发送配置**（与数据包发送相关的配置，如发送速率，源端口，发送线程数量，源地址配置等），**接收配置**（与数据包接收相关的配置，如数据包过滤规则，输出模块配置等），**探测模块配置**（如ICMP，TCP，UDP等探测与协议分析模块），其它配置（如目标拦截器配置，某些探测模式的专门配置等）。

**在探测模式构造完毕后，按构造好的探测模式执行探测**。上图中的探测模式执行部分提供一个简单探测模式的示例。在探测模式执行部分通常具有两个相对独立的部分，**发送过程**和**接收过程**。在发送过程中，**目标迭代器**生成探测目标，在经过目标拦截器过滤后使用指定**探测模块**构造探测数据包并进行发送。在接收过程中，**由相同的探测模块对数据包进行接收和验证**，从中提取有用的信息转交**输出模块**进行输出，并统计相关信息转交目标迭代器以优化后续的目标生成。

## 目标迭代器

在SMap中，目标迭代器是用以生成探测目标的关键组件。以下是当前SMap支持的目标迭代器种类：

乘法循环群迭代器：该迭代器最早由Zmap提出，是一种基于数学乘法循环群理论的目标迭代算法，用于随机化连续的目标范围，可用于IP网段、连续的IP范围、IPv6模式字符串、连续范围的IP和端口组合、连续范围的IP和跳数限制组合等。

文件目标迭代器：从文件中读取地址，地址端口对，其他以文件为承载的探测目标。

IPv6活跃地址迭代器：以种子地址为输入，使用密度聚类，层级聚类等方法构造地址空间树，通过聚类信息推断出种子地址中不存在但可能存活的其它活跃地址。

IPv6地址端口对迭代器：以已知IP、端口的组合为输入，使用密度聚类构造聚类空间，并推断出可能存活的地址端口对。

开放端口迭代器：基于概率相关图等概率模型，使用强化学习策略对地址的开放端口进行推断。

拓扑发现迭代器：用于IPv4和IPv6网络，基于Traceroute的拓扑探测算法。

IPv6路由接口迭代器：实现了Treestrace和6Scour等接口发现算法，用于大规模IPv6路由接口发现。

IPv6别名检测迭代器：实现了APD，PAPD等别名检测探测算法，用于IPv6别名地址检测。

边缘设备发现迭代器：用于边缘路由接口发现。

## 探测模块

SMap目前内置了四种类型的探测模块，具体包括：

活跃目标探测模块：实现了IPv4，IPv6的ICMP，TCP，UDP等多种协议的探测与协议分析模块，用于对探测目标（包括活跃地址，开放端口等）进行存活检测。

自定义编码的活跃目标探测模块：与活跃目标探测模块相似，唯一区别是支持由目标迭代器自定义数据包编码。一般用于IPv6活跃目标生成算法、IPv6别名检测算法等。

拓扑探测模块：实现了IPv4，IPv6的基于ICMP，TCP，UDP等多种不同协议的拓扑探测模块。

自定义编码的拓扑探测模块：与拓扑探测模块类似，唯一区别是支持由目标迭代器自定义数据包编码。