## 概述

每个探测模式都是一个**独立完整的探测流程**，由**定义**，**构造**，**执行**三个部分组成。

探测模式在`src/modes`下进行编写，需要实现三个源文件：

- `mod.rs` 探测模式的**结构定义**，一般包含**基础配置**，**发送配置**，**接收配置**，以及探测模式需要的其它数据结构。
- `new.rs` 探测模式的**构造**函数，在根据命令参数和系统信息对探测模式进行构造。此处构造出的探测模式结构体在整个探测过程中不会发生改变。
- `execute.rs` 探测模式的**执行**函数，**为探测模式实现`ModeMethod`特质**。

!> 请注意必须为探测模式实现 [模式声明](#ms) 、`ModeMethod`特质。

下面是模式构建的常用工具函数和声明宏。

> 不同的探测模式需要不同的**目标迭代器**，**不同类型的探测模块**，**其它工具**（如目标拦截器等），这些模块请根据对应章节按需添加。
>
> 本文档仅介绍相对常用的函数和声明宏，适用于各类更具体需求的工具函数请参阅代码文档。

## 构造函数

构造函数一般为`new(args:&Args)`，用于**在探测逻辑执行前**进行**参数解析**以及**构造出必要的数据结构**。

!> 该部分构造出的**探测模式结构体**在探测逻辑执行中**不可变**。   
请勿在构造函数中将**大量数据**写入**探测模式结构体**。

### 基础配置

```rust
let mut base_conf = BaseConf::new(args:&Args);
```

参数：命令行参数

用途：设置用于探测的网络接口，加密机，配置和结果保存文件等

### 发送基础配置

```rust
let sender_conf = new(args:&Args, interface:&Vec<InterfaceConf>, target_num:Option<u64>, cool_num:Option<i64>, max_packet_length:usize, have_v4:bool, have_v6:bool)
```

**前置模块**：基础配置， 探测模块

参数：命令行参数， 接口列表（由**基础配置**得到），探测目标数量（可为空），冷却次数（可为空，为空时默认为1），最大包长度（由**探测模块**得到），探测目标是否包含IPv4，探测目标是否包含IPv6

### 接收基础配置

```rust
let receiver_conf = ReceiverBaseConf::new(args:&Args, probe_filter:Vec<String>);
```

前置模块：探测模块

参数：命令行参数，pcap过滤字符串（由**探测模块**得到）

### 目标端口解析

```rust
let tar_ports = TarIterBaseConf::parse_tar_port(&args.tar_ports, "default_ports");
```

将输入的字符串格式的端口范围解析为端口数组，当目标端口未设置时读取`sys_conf.ini`文件中conf下的"default_ports"条目对应的端口。"default_ports"可替换为其它标签，替换后将读取对应标签的值作为默认接口。

### 解析自定义函数

```rust
let module_conf = ModuleConf::new_from_vec_args(&args.custom_args, vec!["参数名1=参数值1","参数名2=参数值2"...]);
```

解析终端命令中形如`-a 参数名=参数值` 的 **自定义参数**。该函数的第二个参数为**附加自定义参数**，其效果相当于用户在终端命令中多加了这个参数。**注意这里的优先级高于终端命令中的优先级，这意味着用户指定的相同参数会失效**。

```rust
get_conf_from_mod_or_sys!(module_conf; 自定义参数名1, 自定义参数名2, 自定义参数名3...);
```

用于获取具体的自定义参数值。

### 探测参数记录

```rust
write_to_summary!(base_conf; "探测模式名称"; "args"; args;);
```

将探测时使用的参数进行记录

## 执行函数

>  **执行函数一般流程示例**如下图。  
>  请注意这只是一个简单的探测逻辑流程示例，具体方案需要根据探测算法进行具体设计。

```mermaid
flowchart LR
    A[创建管道] --> B[执行接收线程]
    B --> C[接收准备完成]
    C --> D[执行发送线程]
    D --> E[发送线程结束]
    E --> F[结束接收线程]
    F --> G[处理探测结果]
```

### 创建线程间通信管道

```rust
creat_channels!((recv_ready_sender, recv_ready_receiver, bool),(recv_close_time_sender, recv_close_time_receiver, i64));
```

该声明宏一般用于创建**接收线程**和**发送线程**之间的通讯管道。每个括号内：（发送者，接收者，传递量数据类型），可生成的管道对数量不限。**一般情况下复制该代码即可**。

### 数据准备

```rust
prepare_data!(self; 参数名);			  <=> let 参数名 = self.参数名;
prepare_data!(;clone;参数名); <=> let 参数名 = 参数名.clone();
prepare_data!(self; clone; 参数名); <=> let 参数名 = self.参数名.clone();
```

该声明宏用于在启动**接收线程**或**发送线程**前进行**数据准备**。

### 接收准备完成

```rust
recv_ready!(recv_ready_receiver);
```

在执行函数中用于暂时**阻塞执行函数**，直到**确认接收线程已经启动接收**后放行。

### 等待发送线程

```rust
wait_sender_threads!(sender_threads; 发送线程返回变量1, 发送线程返回变量2...;{
        变量1总和 += 发送线程返回变量1;
        变量2总和 += 发送线程返回变量2;
        ...
});
```

在执行函数中用于暂时**阻塞执行函数**，直到**所有发送线程结束**后放行。第一个分号内的参数为**发送线程列表**，第二个分号内的参数为**发送线程返回变量**，第二个分号后的参数为**发送线程返回变量的处理代码块**。

### 结束接收线程

```rust
ending_the_receiving_thread!(self; recv_close_time_sender);
```

在发送线程结束后根据**冷却时间**参数计算接收线程应该结束的时间，并向接收线程传递。接收线程将在规定的结束时间结束数据包接收。

!> **冷却时间（cool_seconds）**是无状态探测工具的最重要参数之一，它决定**每次发送完成后需要等待多久才结束数据包接收**。ZMap和SMap中这个参数默认均为8秒。各个探测算法需要手动调整以避免用时过长，**尤其是需要分轮次进行探测的动态探测算法**。

### 计算运行时间

```rust
computing_time!(start_time; end_time, running_time);
computing_time!(start_time, end_time; running_time);
```

用于计算运行时间的声明宏。`computing_time!(start_time; end_time, running_time);`表示以已知的开始时间为起点，计算到**当前时间（end_time）**之间的运行时间。`computing_time!(start_time, end_time; running_time);`计算已知的开始时间和**已知的结束时间（非现在）**之间的运行时间。

### 探测结果记录

```rust
write_to_summary!(self; "探测模式名称"; "result";
    [参数名1, 参数名2;];
    #[结构体1; 结构体1变量1; ("结构体1变量2 的记录名", 结构体1变量2)]
);
```

用于保存探测结果摘要。如果是直接可以访问的单独变量，则使用`[参数名1, 参数名2;];`；如果需要记录的变量包裹在结构体内，则使用`#[结构体1; 结构体1变量1; ("结构体1变量2 的记录名", 结构体1变量2)]`；一般情况下直接以变量名作为记录名，如果需要改名，请在对应分号后使用`("记录名", 变量)`的形式进行修改。

## 发送与接收函数

发送与接收函数在模式的执行函数中被调用。

SMap的发送函数在`src/core/sender`路径下实现。对于一般任务来说`base`下的内置方法已经足够，但需要实现对应特质。如果用户需要自定义发送函数，请参照类似功能的发送函数进行编写，通常只需要复制粘贴后修改少量代码。

SMap的接收函数在`src/core/receiver`路径下实现，相关说明与发送函数一致。

## 注意事项

### 模式声明 :id=ms

任何模式都必须在`src/modes/mod.rs`进行声明。

声明包括两部分内容：

- 在MODES数组中声明探测模式处于激活状态
- 在`fn new(args:&Args) -> Box<dyn ModeMethod>`函数中加入探测模式的构造函数

探测模式及探测模块的帮助模式需要在`src/modes/helper_mode/modules_helper.rs`中进行声明。

### 系统信息调用与日志打印调用

```rust
SYS.get_info("区域名称", "键名称");
SYS.get_conf("区域名称", "键名称");
```

SYS系统信息结构体**可以在程序的任何地方进行调用**，以获取**编译时**传入的`sys_conf.ini`中的**默认配置**与**提示语句**信息。

```rust
error!("{}", 变量);
warn!("{}", 变量);
info!("{}", 变量);
debug!("{}", 变量);
trace!("{}", 变量);
```

**日志打印函数**也可在程序的任何地方进行调用。
